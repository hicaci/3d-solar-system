<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3Då¤ªé˜³ç³»è¡Œæ˜Ÿç³»ç»Ÿ - é«˜ç«¯ç§‘æŠ€ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000000;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #ffffff;
    }

    #canvas-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    canvas {
      display: block;
    }

    .planet-label {
      position: absolute;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.9), rgba(9, 9, 121, 0.9));
      border: 1px solid rgba(0, 212, 255, 0.5);
      border-radius: 20px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.6), 
                  inset 0 0 10px rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      letter-spacing: 1px;
    }

    .planet-label.visible {
      opacity: 1;
    }

    .planet-label::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #00d4ff, #090979, #00d4ff);
      border-radius: 22px;
      z-index: -1;
      opacity: 0.5;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .ui-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #00d4ff 0%, #0979d4 50%, #00d4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
      letter-spacing: 2px;
    }

    .subtitle {
      font-size: 14px;
      color: rgba(0, 212, 255, 0.7);
      letter-spacing: 1px;
    }

    .date-panel {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(9, 9, 121, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 15px;
      padding: 20px 30px;
      backdrop-filter: blur(10px);
      z-index: 100;
      min-width: 400px;
      cursor: move;
      user-select: none;
    }

    .date-panel-header {
      cursor: move;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
      margin-bottom: 15px;
    }

    .date-panel-title {
      font-size: 16px;
      font-weight: 600;
      color: #00d4ff;
      text-align: center;
      letter-spacing: 1px;
      cursor: move;
    }

    .date-panel-content {
      cursor: default;
      user-select: text;
    }

    .date-input-group {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .date-input-label {
      font-size: 13px;
      color: rgba(0, 212, 255, 0.8);
      min-width: 70px;
    }

    .date-input {
      flex: 1;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 212, 255, 0.4);
      border-radius: 8px;
      padding: 8px 12px;
      color: #ffffff;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
    }

    .date-input:focus {
      border-color: rgba(0, 212, 255, 0.8);
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    }

    .date-input::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    .date-display {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 10px 15px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: #00d4ff;
      letter-spacing: 1px;
    }

    .slider-group {
      margin-top: 15px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(0, 212, 255, 0.6);
      margin-bottom: 8px;
    }

    .date-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(0, 212, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
      cursor: pointer;
    }

    .date-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00d4ff, #0979d4);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
      transition: all 0.2s ease;
    }

    .date-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 15px rgba(0, 212, 255, 1);
    }

    .date-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00d4ff, #0979d4);
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
    }

    .quick-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    .quick-btn {
      padding: 6px 12px;
      background: rgba(0, 212, 255, 0.2);
      border: 1px solid rgba(0, 212, 255, 0.4);
      border-radius: 15px;
      color: #00d4ff;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quick-btn:hover {
      background: rgba(0, 212, 255, 0.4);
      border-color: rgba(0, 212, 255, 0.8);
    }

    .quick-btn.active {
      background: rgba(0, 212, 255, 0.5);
      border-color: rgba(0, 212, 255, 1);
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    .controls-panel {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 100;
      align-items: center;
    }

    .planet-selector {
      padding: 10px 15px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(9, 9, 121, 0.2));
      border: 1px solid rgba(0, 212, 255, 0.4);
      border-radius: 25px;
      color: #00d4ff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      letter-spacing: 1px;
      outline: none;
      min-width: 120px;
    }

    .planet-selector:hover {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.4), rgba(9, 9, 121, 0.4));
      border-color: rgba(0, 212, 255, 0.8);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
    }

    .planet-selector option {
      background: #0a0a23;
      color: #00d4ff;
      padding: 10px;
    }

    .control-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(9, 9, 121, 0.2));
      border: 1px solid rgba(0, 212, 255, 0.4);
      border-radius: 25px;
      color: #00d4ff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      letter-spacing: 1px;
    }

    .control-btn:hover {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.4), rgba(9, 9, 121, 0.4));
      border-color: rgba(0, 212, 255, 0.8);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      transform: translateY(-2px);
    }

    .info-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(9, 9, 121, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 15px;
      padding: 20px;
      min-width: 300px;
      max-width: 350px;
      backdrop-filter: blur(10px);
      z-index: 100;
      display: none;
    }

    .info-panel.visible {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .info-title {
      font-size: 20px;
      font-weight: 700;
      color: #00d4ff;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 212, 255, 0.3);
    }

    .info-item {
      margin: 10px 0;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
    }

    .info-label {
      color: rgba(0, 212, 255, 0.7);
      font-weight: 600;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 25px;
      height: 25px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 50%;
      color: #00d4ff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(0, 212, 255, 0.2);
      border-color: rgba(0, 212, 255, 0.6);
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1000;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid rgba(0, 212, 255, 0.2);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #00d4ff;
      font-size: 16px;
      letter-spacing: 2px;
    }

    .hint {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(0, 212, 255, 0.5);
      font-size: 12px;
      letter-spacing: 1px;
      z-index: 100;
    }

    .knowledge-panel {
      position: absolute;
      bottom: 80px;
      right: 20px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(9, 9, 121, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 15px;
      padding: 15px;
      max-width: 280px;
      backdrop-filter: blur(10px);
      z-index: 100;
      font-size: 12px;
      line-height: 1.6;
    }

    .knowledge-title {
      color: #00d4ff;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .knowledge-text {
      color: rgba(255, 255, 255, 0.7);
    }

    .mobile-menu-btn {
      display: none;
      position: absolute;
      top: 10px;
      right: 10px;
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.3), rgba(9, 9, 121, 0.3));
      border: 1px solid rgba(0, 212, 255, 0.5);
      border-radius: 10px;
      color: #00d4ff;
      font-size: 20px;
      cursor: pointer;
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 150;
    }

    .mobile-menu-overlay.active {
      display: block;
    }

    @media screen and (max-width: 768px) {
      .title {
        font-size: 20px;
        letter-spacing: 1px;
      }

      .subtitle {
        font-size: 11px;
      }

      .ui-overlay {
        top: 10px;
        left: 10px;
      }

      .date-panel {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        transform: none;
        min-width: auto;
        width: 100%;
        max-height: 60vh;
        overflow-y: auto;
        border-radius: 20px 20px 0 0;
        padding: 15px;
        z-index: 160;
        display: none;
      }

      .date-panel.mobile-visible {
        display: block;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .date-panel-header {
        cursor: default;
      }

      .date-input-group {
        flex-direction: column;
        gap: 8px;
      }

      .date-input-label {
        min-width: auto;
      }

      .date-display {
        font-size: 16px;
        padding: 8px 12px;
      }

      .quick-buttons {
        flex-wrap: wrap;
        gap: 6px;
      }

      .quick-btn {
        padding: 8px 14px;
        font-size: 13px;
        min-height: 44px;
      }

      .navigation-buttons {
        flex-wrap: wrap;
      }

      .controls-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        transform: none;
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
        justify-content: center;
      }

      .controls-panel.mobile-hidden {
        display: none;
      }

      .planet-selector {
        min-width: 100px;
        padding: 12px 15px;
        font-size: 14px;
      }

      .control-btn {
        padding: 12px 16px;
        font-size: 12px;
        min-height: 44px;
      }

      .info-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        min-width: auto;
        max-width: none;
        width: 100%;
        height: 100%;
        border-radius: 0;
        z-index: 180;
        overflow-y: auto;
        padding: 20px;
        padding-top: 60px;
      }

      .info-panel.visible {
        animation: none;
      }

      .info-title {
        font-size: 24px;
      }

      .info-item {
        font-size: 14px;
        margin: 12px 0;
      }

      .close-btn {
        top: 15px;
        right: 15px;
        width: 44px;
        height: 44px;
        font-size: 24px;
      }

      .knowledge-panel {
        display: none;
        position: fixed;
        bottom: 100px;
        left: 10px;
        right: 10px;
        max-width: none;
        z-index: 90;
      }

      .knowledge-panel.mobile-visible {
        display: block;
      }

      .hint {
        display: none;
      }

      .mobile-hint {
        display: block !important;
        position: fixed;
        bottom: 70px;
        left: 10px;
        right: 10px;
        font-size: 11px;
        text-align: center;
        z-index: 50;
      }

      .mobile-menu-btn {
        display: flex;
      }

      .planet-label {
        font-size: 12px;
        padding: 6px 12px;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
      }

      .loading-text {
        font-size: 14px;
      }
    }

    @media screen and (max-width: 480px) {
      .title {
        font-size: 18px;
      }

      .subtitle {
        font-size: 10px;
      }

      .date-panel-title {
        font-size: 14px;
      }

      .slider-label {
        font-size: 11px;
      }

      .quick-btn {
        padding: 10px 12px;
        font-size: 12px;
      }

      .control-btn {
        padding: 10px 12px;
        font-size: 11px;
      }

      .planet-selector {
        min-width: 90px;
        font-size: 12px;
        padding: 10px 12px;
      }
    }

    @media screen and (min-width: 769px) {
      .date-panel {
        display: block !important;
      }
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">æ­£åœ¨åŠ è½½3Dè¡Œæ˜Ÿç³»ç»Ÿ...</div>
    </div>

    <div class="ui-overlay">
      <div class="title">å¤ªé˜³ç³»è¡Œæ˜Ÿç³»ç»Ÿ</div>
      <div class="subtitle">SOLAR SYSTEM EXPLORER</div>
    </div>

    <button class="mobile-menu-btn" id="mobile-menu-btn">â˜°</button>
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>

    <div class="date-panel" id="date-panel">
      <div class="date-panel-header" id="date-panel-header">
        <div class="date-panel-title">â± æ—¶é—´æ§åˆ¶å™¨ <span style="font-size: 10px; opacity: 0.6;">[å¯æ‹–åŠ¨]</span></div>
      </div>
      <div class="date-panel-content">
        <div class="date-input-group">
          <span class="date-input-label">é€‰æ‹©æ—¥æœŸï¼š</span>
          <input type="date" id="date-input" class="date-input">
        </div>
        <div class="date-display" id="current-date">2024å¹´01æœˆ01æ—¥</div>
        <div class="slider-group">
          <div class="slider-label">
            <span>å¹´åˆ</span>
            <span>å¹´æœ«</span>
          </div>
          <input type="range" id="date-slider" class="date-slider" min="0" max="365" value="0">
        </div>
        <div class="quick-buttons">
          <span style="font-size: 12px; color: rgba(0, 212, 255, 0.7); margin-right: 10px;">æ­¥ä¼ï¼š</span>
          <button class="quick-btn active" id="step-day" data-step="1">å¤©</button>
          <button class="quick-btn" id="step-week" data-step="7">å‘¨</button>
          <button class="quick-btn" id="step-month" data-step="30">æœˆ</button>
          <button class="quick-btn" id="step-year" data-step="365">å¹´</button>
        </div>
        <div class="navigation-buttons" style="display: flex; gap: 10px; margin-top: 10px; justify-content: center;">
          <button class="quick-btn" id="prev-btn" style="padding: 8px 20px;">â—€ å‰é€€</button>
          <button class="quick-btn" id="today-btn" style="padding: 8px 20px;">ä»Šå¤©</button>
          <button class="quick-btn" id="next-btn" style="padding: 8px 20px;">å‰è¿› â–¶</button>
        </div>
        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0, 212, 255, 0.2); text-align: center;">
          <button class="quick-btn active" id="realtime-btn" style="padding: 8px 15px;">ğŸŒ å®æ—¶æ•°æ®</button>
          <button class="quick-btn" id="simulate-btn" style="padding: 8px 15px;">ğŸ“Š æ¨¡æ‹Ÿæ¨¡å¼</button>
          <div id="data-status" style="font-size: 10px; color: rgba(0, 212, 255, 0.5); margin-top: 5px;">ä½¿ç”¨NASA JPLå®æ—¶æ•°æ®</div>
        </div>
      </div>
    </div>

    <div class="info-panel" id="info-panel">
      <button class="close-btn" id="close-info">Ã—</button>
      <div class="info-title" id="planet-name">åœ°çƒ</div>
      <div class="info-item">
        <span class="info-label">è‹±æ–‡åï¼š</span>
        <span id="planet-name-en">Earth</span>
      </div>
      <div class="info-item">
        <span class="info-label">è·ç¦»å¤ªé˜³ï¼š</span>
        <span id="planet-distance">1.00 AU</span>
      </div>
      <div class="info-item">
        <span class="info-label">å…¬è½¬å‘¨æœŸï¼š</span>
        <span id="planet-period">365.25 å¤©</span>
      </div>
      <div class="info-item">
        <span class="info-label">è½¨é“å€¾è§’ï¼š</span>
        <span id="planet-inclination">0.00Â°</span>
      </div>
      <div class="info-item">
        <span class="info-label">ç›´å¾„ï¼š</span>
        <span id="planet-diameter">12,742 km</span>
      </div>
      <div class="info-item">
        <span class="info-label">è¡¨é¢æ¸©åº¦ï¼š</span>
        <span id="planet-temperature">-88Â°C è‡³ 58Â°C</span>
      </div>
      <div class="info-item" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0, 212, 255, 0.2);">
        <span class="info-label">è¶£å‘³çŸ¥è¯†ï¼š</span>
        <div id="planet-fact" style="color: rgba(255, 255, 255, 0.6); margin-top: 5px;"></div>
      </div>
    </div>

    <div class="knowledge-panel">
      <div class="knowledge-title">å¤©æ–‡å°çŸ¥è¯†</div>
      <div class="knowledge-text">
        è¡Œæ˜Ÿè½¨é“å¹¶ééƒ½åœ¨åŒä¸€å¹³é¢ä¸Šã€‚æ°´æ˜Ÿè½¨é“å€¾è§’æœ€å¤§ï¼ˆ7Â°ï¼‰ï¼Œå…¶ä»–è¡Œæ˜Ÿè½¨é“ä¸åœ°çƒè½¨é“é¢ï¼ˆé»„é“é¢ï¼‰çš„å¤¹è§’å„ä¸ç›¸åŒã€‚è¿™æ¨¡æ‹Ÿäº†çœŸå®çš„è¡Œæ˜Ÿè½¨é“å€¾æ–œæƒ…å†µã€‚
      </div>
    </div>

    <div class="controls-panel">
      <select id="planet-selector" class="planet-selector">
        <option value="sun">â˜€ å¤ªé˜³</option>
        <option value="0">â˜¿ æ°´æ˜Ÿ</option>
        <option value="1">â™€ é‡‘æ˜Ÿ</option>
        <option value="2">âŠ• åœ°çƒ</option>
        <option value="3">â™‚ ç«æ˜Ÿ</option>
        <option value="4">â™ƒ æœ¨æ˜Ÿ</option>
        <option value="5">â™„ åœŸæ˜Ÿ</option>
        <option value="6">â™… å¤©ç‹æ˜Ÿ</option>
        <option value="7">â™† æµ·ç‹æ˜Ÿ</option>
        <option value="8">â™‡ å†¥ç‹æ˜Ÿ</option>
      </select>
      <button class="control-btn" id="toggle-orbits">æ˜¾ç¤ºè½¨é“</button>
      <button class="control-btn" id="toggle-labels">æ˜¾ç¤ºæ ‡ç­¾</button>
      <button class="control-btn" id="reset-view">é‡ç½®è§†å›¾</button>
      <button class="control-btn" id="auto-rotate">åœæ­¢æ—‹è½¬</button>
    </div>

    <div class="hint">æ‹–åŠ¨é¼ æ ‡æ—‹è½¬è§†è§’ | æ»šè½®ç¼©æ”¾ | ç‚¹å‡»ä»»æ„ä½ç½®è®¾ç½®ç¼©æ”¾ä¸­å¿ƒ | ç‚¹å‡»è¡Œæ˜ŸæŸ¥çœ‹è¯¦æƒ…</div>
    <div class="hint mobile-hint" style="display: none;">ç‚¹å‡»å³ä¸Šè§’èœå•æŒ‰é’®æ‰“å¼€æ§åˆ¶é¢æ¿ | å•æŒ‡æ‹–åŠ¨æ—‹è½¬ | åŒæŒ‡ç¼©æ”¾ | ç‚¹å‡»è¡Œæ˜ŸæŸ¥çœ‹è¯¦æƒ… | åŒå‡»è¡Œæ˜Ÿæ”¾å¤§</div>
  </div>

  <div class="planet-label" id="planet-label"></div>

  <script>
    let scene, camera, renderer, controls;
    let sun = null;
    let planets = [];
    let orbits = [];
    let satellites = [];
    let labels = [];
    let raycaster, mouse;
    let selectedPlanet = null;
    let showOrbits = true;
    let showLabels = false;
    let autoRotate = true;
    let selectedDate = new Date();
    let isAnimating = false;
    let zoomTarget = null;
    let isZoomTargetSet = false;
    let textureLoader = null;
    let useRealTimeData = true;
    let realTimeUpdateInterval = null;

    const J2000 = new Date('2000-01-01T12:00:00Z');

    const NASA_API_BASE = 'https://ssd.jpl.nasa.gov/api/horizons.api';

    const planetHorizonsId = {
      mercury: '199',
      venus: '299',
      earth: '399',
      mars: '499',
      jupiter: '599',
      saturn: '699',
      uranus: '799',
      neptune: '899',
      pluto: '999'
    };

    const textureURLs = {
      sun: './image/2k_sun.jpg',
      mercury: './image/2k_mercury.jpg',
      venus: './image/2k_venus_surface.jpg',
      earth: './image/2k_earth_daymap.jpg',
      mars: './image/2k_mars.jpg',
      jupiter: './image/2k_jupiter.jpg',
      saturn: './image/2k_saturn.jpg',
      uranus: './image/2k_uranus.jpg',
      neptune: './image/2k_neptune.jpg',
      pluto: './image/2k_pluto.jpg',
      moon: './image/2k_moon.jpg',
      saturnRing: './image/2k_saturn_ring_alpha.png',
      earthNight: './image/2k_earth_nightmap.jpg'
    };

    const satelliteData = {
      earth: [
        { name: "æœˆçƒ", nameEn: "Moon", distance: 2.5, size: 0.35, color: 0xcccccc, period: 27.3 }
      ],
      mars: [
        { name: "ç«å«ä¸€", nameEn: "Phobos", distance: 1.5, size: 0.1, color: 0x8b7355, period: 0.32 },
        { name: "ç«å«äºŒ", nameEn: "Deimos", distance: 2.0, size: 0.08, color: 0x8b7355, period: 1.26 }
      ],
      jupiter: [
        { name: "æœ¨å«ä¸€ï¼ˆè‰¾å¥¥ï¼‰", nameEn: "Io", distance: 5.5, size: 0.4, color: 0xffff00, period: 1.77 },
        { name: "æœ¨å«äºŒï¼ˆæ¬§ç½—å·´ï¼‰", nameEn: "Europa", distance: 7.0, size: 0.35, color: 0xf5f5dc, period: 3.55 },
        { name: "æœ¨å«ä¸‰ï¼ˆç›–å°¼ç±³å¾·ï¼‰", nameEn: "Ganymede", distance: 9.0, size: 0.5, color: 0x808080, period: 7.15 },
        { name: "æœ¨å«å››ï¼ˆå¡é‡Œæ–¯æ‰˜ï¼‰", nameEn: "Callisto", distance: 11.0, size: 0.45, color: 0x696969, period: 16.69 }
      ],
      saturn: [
        { name: "åœŸå«å…­ï¼ˆæ³°å¦ï¼‰", nameEn: "Titan", distance: 8.0, size: 0.5, color: 0xffa500, period: 15.95 },
        { name: "åœŸå«äºŒï¼ˆæ©å…‹æ‹‰å¤šæ–¯ï¼‰", nameEn: "Enceladus", distance: 5.0, size: 0.2, color: 0xffffff, period: 1.37 },
        { name: "åœŸå«äº”ï¼ˆç‘äºšï¼‰", nameEn: "Rhea", distance: 6.0, size: 0.25, color: 0xc0c0c0, period: 4.52 }
      ],
      uranus: [
        { name: "å¤©å«ä¸‰ï¼ˆæ³°å¦å¦®äºšï¼‰", nameEn: "Titania", distance: 4.5, size: 0.2, color: 0xadd8e6, period: 8.71 },
        { name: "å¤©å«å››ï¼ˆå¥¥ä¼¯é¾™ï¼‰", nameEn: "Oberon", distance: 5.5, size: 0.2, color: 0xb0c4de, period: 13.46 }
      ],
      neptune: [
        { name: "æµ·å«ä¸€ï¼ˆç‰¹é‡ŒåŒï¼‰", nameEn: "Triton", distance: 4.0, size: 0.3, color: 0xffc0cb, period: 5.88 }
      ],
      pluto: [
        { name: "å¡æˆ", nameEn: "Charon", distance: 1.5, size: 0.25, color: 0x808080, period: 6.39 }
      ]
    };

    const planetData = [
      {
        name: "æ°´æ˜Ÿ",
        nameEn: "Mercury",
        distance: 0.387,
        size: 0.8,
        color: 0xa9a9a9,
        period: 87.97,
        rotationPeriod: 58.65,
        diameter: 4879,
        mass: "3.30 Ã— 10Â²Â³ kg",
        gravity: "3.7 m/sÂ²",
        satellites: 0,
        temperature: "-173Â°C è‡³ 427Â°C",
        atmosphere: "æç¨€è–„ï¼ˆé’ ã€é’¾ã€æ°§ï¼‰",
        fact: "æ°´æ˜Ÿæ˜¯å¤ªé˜³ç³»ä¸­æœ€å°çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¦»å¤ªé˜³æœ€è¿‘çš„è¡Œæ˜Ÿã€‚å®ƒè¡¨é¢å¸ƒæ»¡äº†é™¨çŸ³å‘ï¼Œçœ‹èµ·æ¥å¾ˆåƒæœˆçƒã€‚ç”±äºç¦»å¤ªé˜³å¾ˆè¿‘ï¼Œæ°´æ˜Ÿä¸Šçš„ä¸€å¤©ç›¸å½“äºåœ°çƒä¸Šçš„59å¤©ï¼",
        discovery: "ã€2023å¹´æ–°å‘ç°ã€‘BepiColomboæ¢æµ‹å™¨å‘ç°æ°´æ˜Ÿè¡¨é¢å­˜åœ¨æ›´å¤šæ°´å†°æ²‰ç§¯ï¼Œä¸»è¦åˆ†å¸ƒåœ¨æ°¸ä¹…é˜´å½±çš„æåœ°é™¨çŸ³å‘ä¸­ã€‚ç§‘å­¦å®¶è¿˜å‘ç°æ°´æ˜Ÿæ­£åœ¨ä»¥æ¯å¹´çº¦5å˜ç±³çš„é€Ÿåº¦æ”¶ç¼©ã€‚",
        orbitColor: 0x666666,
        inclination: 7.0,
        eccentricity: 0.206,
        meanAnomalyJ2000: 174.796
      },
      {
        name: "é‡‘æ˜Ÿ",
        nameEn: "Venus",
        distance: 0.723,
        size: 1.2,
        color: 0xe6c26e,
        period: 224.70,
        rotationPeriod: -243.02,
        diameter: 12104,
        mass: "4.87 Ã— 10Â²â´ kg",
        gravity: "8.87 m/sÂ²",
        satellites: 0,
        temperature: "462Â°C",
        atmosphere: "äºŒæ°§åŒ–ç¢³ï¼ˆ96.5%ï¼‰ã€æ°®æ°”",
        fact: "é‡‘æ˜Ÿæ˜¯å¤ªé˜³ç³»ä¸­æœ€çƒ­çš„è¡Œæ˜Ÿï¼Œè¡¨é¢æ¸©åº¦é«˜è¾¾462Â°Cï¼Œè¶³ä»¥ç†”åŒ–é“…ï¼å®ƒè¢«åšåšçš„äºŒæ°§åŒ–ç¢³å¤§æ°”å±‚åŒ…å›´ï¼Œäº§ç”Ÿäº†å¼ºçƒˆçš„æ¸©å®¤æ•ˆåº”ã€‚é‡‘æ˜Ÿçš„è‡ªè½¬æ–¹å‘ä¸å…¶ä»–è¡Œæ˜Ÿç›¸åã€‚",
        discovery: "ã€2023å¹´æ–°å‘ç°ã€‘ç§‘å­¦å®¶åœ¨é‡‘æ˜Ÿå¤§æ°”ä¸­æ£€æµ‹åˆ°ç£·åŒ–æ°¢æ°”ä½“ï¼Œè¿™å¯èƒ½æ˜¯ç”Ÿå‘½å­˜åœ¨çš„è¿¹è±¡ã€‚æ–°çš„é›·è¾¾å›¾åƒæ˜¾ç¤ºé‡‘æ˜Ÿè¡¨é¢å­˜åœ¨æ´»è·ƒçš„ç«å±±æ´»åŠ¨ï¼Œæœ€è¿‘å¯èƒ½å‘ç”Ÿè¿‡å–·å‘ã€‚",
        orbitColor: 0x996600,
        inclination: 3.4,
        eccentricity: 0.007,
        meanAnomalyJ2000: 50.115
      },
      {
        name: "åœ°çƒ",
        nameEn: "Earth",
        distance: 1.000,
        size: 1.3,
        color: 0x6495ed,
        period: 365.25,
        rotationPeriod: 0.997,
        diameter: 12742,
        mass: "5.97 Ã— 10Â²â´ kg",
        gravity: "9.81 m/sÂ²",
        satellites: 1,
        temperature: "-88Â°C è‡³ 58Â°C",
        atmosphere: "æ°®æ°”ï¼ˆ78%ï¼‰ã€æ°§æ°”ï¼ˆ21%ï¼‰",
        fact: "åœ°çƒæ˜¯å¤ªé˜³ç³»ä¸­å”¯ä¸€å·²çŸ¥å­˜åœ¨ç”Ÿå‘½çš„è¡Œæ˜Ÿï¼å®ƒè¡¨é¢æœ‰71%è¢«æ°´è¦†ç›–ï¼Œå› æ­¤ä»å¤ªç©ºçœ‹å‘ˆç°ç¾ä¸½çš„è“è‰²ã€‚åœ°çƒæœ‰ä¸€é¢—å¤©ç„¶å«æ˜Ÿâ€”â€”æœˆçƒï¼Œå®ƒå¯¹åœ°çƒçš„æ½®æ±æœ‰é‡è¦å½±å“ã€‚",
        discovery: "ã€2024å¹´æ–°å‘ç°ã€‘è©¹å§†æ–¯Â·éŸ¦ä¼¯å¤ªç©ºæœ›è¿œé•œå‘ç°äº†æ›´å¤šç³»å¤–è¡Œæ˜Ÿï¼Œç§‘å­¦å®¶æ­£åœ¨ç ”ç©¶åœ°çƒå¤§æ°”çš„æ¼”åŒ–å†å²ã€‚æ–°çš„ç ”ç©¶è¡¨æ˜åœ°çƒå†…æ ¸å¯èƒ½æ­£åœ¨å‡é€Ÿæ—‹è½¬ã€‚",
        orbitColor: 0x0066ff,
        inclination: 0.0,
        eccentricity: 0.017,
        meanAnomalyJ2000: 357.517
      },
      {
        name: "ç«æ˜Ÿ",
        nameEn: "Mars",
        distance: 1.524,
        size: 1.0,
        color: 0xff6347,
        period: 686.98,
        rotationPeriod: 1.026,
        diameter: 6779,
        mass: "6.42 Ã— 10Â²Â³ kg",
        gravity: "3.71 m/sÂ²",
        satellites: 2,
        temperature: "-153Â°C è‡³ 20Â°C",
        atmosphere: "äºŒæ°§åŒ–ç¢³ï¼ˆ95%ï¼‰ã€æ°®æ°”",
        fact: "ç«æ˜Ÿè¢«ç§°ä¸º'çº¢è‰²æ˜Ÿçƒ'ï¼Œå› ä¸ºå®ƒè¡¨é¢å¯Œå«æ°§åŒ–é“ï¼ˆé“é”ˆï¼‰ã€‚ç«æ˜Ÿä¸Šæœ‰å¤ªé˜³ç³»ä¸­æœ€é«˜çš„å±±è„‰â€”â€”å¥¥æ—åŒ¹æ–¯å±±ï¼Œé«˜è¾¾22å…¬é‡Œï¼ç«æ˜Ÿçš„ä¸€å¤©ä¸åœ°çƒå‡ ä¹ç›¸åŒï¼Œçº¦ä¸º24.6å°æ—¶ã€‚",
        discovery: "ã€2024å¹´æ–°å‘ç°ã€‘æ¯…åŠ›å·ç«æ˜Ÿè½¦å‘ç°äº†æ›´å¤šæœ‰æœºåˆ†å­è¯æ®ï¼Œç«æ˜Ÿåœ°ä¸‹å¯èƒ½å­˜åœ¨æ¶²æ€æ°´æ¹–æ³Šã€‚ç§‘å­¦å®¶å‘ç°ç«æ˜Ÿæ›¾ç»æ‹¥æœ‰ç±»ä¼¼åœ°çƒçš„ç£åœºï¼Œä½†çº¦40äº¿å¹´å‰æ¶ˆå¤±äº†ã€‚",
        orbitColor: 0xff3300,
        inclination: 1.9,
        eccentricity: 0.093,
        meanAnomalyJ2000: 19.373
      },
      {
        name: "æœ¨æ˜Ÿ",
        nameEn: "Jupiter",
        distance: 5.203,
        size: 3.5,
        color: 0xe6b88a,
        period: 4332.71,
        rotationPeriod: 0.414,
        diameter: 139820,
        mass: "1.90 Ã— 10Â²â· kg",
        gravity: "24.79 m/sÂ²",
        satellites: 95,
        temperature: "-145Â°C",
        atmosphere: "æ°¢æ°”ï¼ˆ90%ï¼‰ã€æ°¦æ°”",
        fact: "æœ¨æ˜Ÿæ˜¯å¤ªé˜³ç³»ä¸­æœ€å¤§çš„è¡Œæ˜Ÿï¼Œå®ƒçš„è´¨é‡æ˜¯å…¶ä»–æ‰€æœ‰è¡Œæ˜Ÿæ€»å’Œçš„2.5å€ï¼æœ¨æ˜Ÿè¡¨é¢æœ‰ä¸€ä¸ªè‘—åçš„å¤§çº¢æ–‘ï¼Œè¿™æ˜¯ä¸€ä¸ªæŒç»­äº†å‡ ç™¾å¹´çš„å·¨å¤§é£æš´ï¼Œæ¯”åœ°çƒè¿˜è¦å¤§ã€‚",
        discovery: "ã€2023å¹´æ–°å‘ç°ã€‘æœ±è¯ºå·æ¢æµ‹å™¨å‘ç°æœ¨æ˜Ÿå¤§çº¢æ–‘æ­£åœ¨ç¼©å°ï¼Œä½†é£æš´æ·±åº¦æ¯”é¢„æœŸæ›´æ·±ã€‚æœ¨å«äºŒæ¬§ç½—å·´çš„åœ°ä¸‹æµ·æ´‹å¯èƒ½å«æœ‰ç”Ÿå‘½æ‰€éœ€çš„åŒ–å­¦ç‰©è´¨ï¼ŒNASAè®¡åˆ’å‘å°„æ¬§ç½—å·´å¿«èˆ¹è¿›è¡Œè¯¦ç»†æ¢æµ‹ã€‚",
        orbitColor: 0xcc9966,
        inclination: 1.3,
        eccentricity: 0.049,
        meanAnomalyJ2000: 20.020
      },
      {
        name: "åœŸæ˜Ÿ",
        nameEn: "Saturn",
        distance: 9.539,
        size: 3.0,
        color: 0xf5deb3,
        period: 10759.50,
        rotationPeriod: 0.444,
        diameter: 116460,
        mass: "5.68 Ã— 10Â²â¶ kg",
        gravity: "10.44 m/sÂ²",
        satellites: 146,
        temperature: "-178Â°C",
        atmosphere: "æ°¢æ°”ï¼ˆ96%ï¼‰ã€æ°¦æ°”",
        fact: "åœŸæ˜Ÿä»¥å…¶ç¾ä¸½çš„ç¯ç³»è€Œé—»åï¼Œè¿™äº›ç¯ç”±æ— æ•°å°å†°å—å’Œå²©çŸ³ç¢ç‰‡ç»„æˆã€‚åœŸæ˜Ÿçš„å¯†åº¦éå¸¸å°ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè¶³å¤Ÿå¤§çš„æ°´æ± ï¼ŒåœŸæ˜Ÿä¼šæ¼‚æµ®åœ¨æ°´é¢ä¸Šï¼å®ƒæœ‰146é¢—å·²çŸ¥å«æ˜Ÿã€‚",
        discovery: "ã€2023å¹´æ–°å‘ç°ã€‘å¡è¥¿å°¼å·æ•°æ®æ˜¾ç¤ºåœŸå«å…­æ³°å¦æ‹¥æœ‰åœ°ä¸‹æµ·æ´‹ï¼ŒåœŸå«äºŒæ©å…‹æ‹‰å¤šæ–¯çš„å†°å–·æ³‰ä¸­å«æœ‰æœ‰æœºåˆ†å­ã€‚åœŸæ˜Ÿç¯å¯èƒ½æ¯”ä¹‹å‰è®¤ä¸ºçš„æ›´å¹´è½»ï¼Œåªæœ‰çº¦1äº¿å¹´å†å²ã€‚",
        orbitColor: 0xccaa77,
        inclination: 2.5,
        eccentricity: 0.057,
        meanAnomalyJ2000: 317.020,
        hasRing: true
      },
      {
        name: "å¤©ç‹æ˜Ÿ",
        nameEn: "Uranus",
        distance: 19.182,
        size: 2.0,
        color: 0x87ceeb,
        period: 30685.00,
        diameter: 50724,
        temperature: "-224Â°C",
        fact: "å¤©ç‹æ˜Ÿçš„è‡ªè½¬è½´ä¸å…¬è½¬è½¨é“å‡ ä¹å‚ç›´ï¼Œå°±åƒä¾§èººç€ç»•å¤ªé˜³å…¬è½¬ï¼å®ƒæ˜¯ç¬¬ä¸€é¢—é€šè¿‡æœ›è¿œé•œå‘ç°çš„è¡Œæ˜Ÿï¼ˆ1781å¹´ï¼‰ã€‚å¤©ç‹æ˜Ÿå‘ˆç°ç¾ä¸½çš„è“ç»¿è‰²ï¼Œæ˜¯å› ä¸ºå¤§æ°”ä¸­å«æœ‰ç”²çƒ·ã€‚",
        orbitColor: 0x66cccc,
        inclination: 0.8,
        eccentricity: 0.046,
        meanAnomalyJ2000: 142.238
      },
      {
        name: "æµ·ç‹æ˜Ÿ",
        nameEn: "Neptune",
        distance: 30.058,
        size: 1.9,
        color: 0x4169e1,
        period: 60190.00,
        diameter: 49244,
        temperature: "-218Â°C",
        fact: "æµ·ç‹æ˜Ÿæ˜¯å¤ªé˜³ç³»ä¸­æœ€è¿œçš„è¡Œæ˜Ÿï¼Œå®ƒæœ‰ç€å¼ºçƒˆçš„é£æš´ï¼Œé£é€Ÿå¯è¾¾æ¯å°æ—¶2100å…¬é‡Œï¼Œæ˜¯å¤ªé˜³ç³»ä¸­é£é€Ÿæœ€å¿«çš„è¡Œæ˜Ÿï¼æµ·ç‹æ˜Ÿæ˜¯é€šè¿‡æ•°å­¦è®¡ç®—é¢„æµ‹ä½ç½®åè¢«å‘ç°çš„ã€‚",
        orbitColor: 0x3366ff,
        inclination: 1.8,
        eccentricity: 0.011,
        meanAnomalyJ2000: 256.228
      },
      {
        name: "å†¥ç‹æ˜Ÿ",
        nameEn: "Pluto",
        distance: 39.482,
        size: 0.6,
        color: 0xd8bfd8,
        period: 90560.00,
        diameter: 2370,
        temperature: "-229Â°C",
        fact: "å†¥ç‹æ˜Ÿæ›¾ç»è¢«è®¤ä¸ºæ˜¯ç¬¬ä¹å¤§è¡Œæ˜Ÿï¼Œä½†åœ¨2006å¹´è¢«é‡æ–°åˆ†ç±»ä¸ºçŸ®è¡Œæ˜Ÿã€‚å®ƒæœ‰ä¸€ä¸ªå·¨å¤§çš„å«æ˜Ÿâ€”â€”å¡æˆï¼Œä¸¤è€…çš„å¤§å°ç›¸å·®ä¸å¤§ï¼Œå°±åƒä¸€å¯¹åŒè¡Œæ˜Ÿåœ¨å¤ªç©ºä¸­èˆè¹ˆã€‚",
        orbitColor: 0x996699,
        inclination: 17.2,
        eccentricity: 0.248,
        meanAnomalyJ2000: 14.53
      }
    ];

    function init() {
      scene = new THREE.Scene();
      
      // Load starfield background
      const textureLoader = new THREE.TextureLoader();
      textureLoader.load('./image/2k_stars_milky_way.jpg', function(texture) {
        scene.background = texture;
      }, undefined, function(error) {
        // Fallback to black background if texture fails to load
        scene.background = new THREE.Color(0x000000);
      });

      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
      camera.position.set(0, 300, 500);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 0.5;
      controls.maxDistance = 5000;
      controls.autoRotate = autoRotate;
      controls.autoRotateSpeed = 0.5;

      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      createSun();
      createPlanets();
      createOrbits();
      addLights();

      initDateControls();

      window.addEventListener('resize', onWindowResize);
      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('click', onMouseClick);
      
      renderer.domElement.addEventListener('wheel', (event) => {
        if (isZoomTargetSet && zoomTarget) {
          event.preventDefault();
          event.stopPropagation();
          
          const zoomSpeed = 0.001;
          const delta = event.deltaY * zoomSpeed;
          const zoomFactor = 1 + delta;
          
          const distance = camera.position.distanceTo(zoomTarget);
          const newDistance = Math.max(controls.minDistance, Math.min(controls.maxDistance, distance * zoomFactor));
          
          const newPos = new THREE.Vector3();
          newPos.subVectors(camera.position, zoomTarget);
          newPos.normalize();
          newPos.multiplyScalar(newDistance);
          newPos.add(zoomTarget);
          
          camera.position.copy(newPos);
        }
      }, { passive: false });

      setupControls();

      document.getElementById('loading').style.display = 'none';

      if (useRealTimeData) {
        startRealTimeUpdates();
      } else {
        updatePlanetPositions();
      }
      animate();
    }

    function initDateControls() {
      const today = new Date();
      selectedDate = today;
      
      let currentStep = 1;
      const slider = document.getElementById('date-slider');
      const sliderLabels = document.querySelector('.slider-label');
      
      const dateInput = document.getElementById('date-input');
      dateInput.value = today.toISOString().split('T')[0];
      
      updateDateDisplay();
      updateSliderForStep(currentStep);

      dateInput.addEventListener('change', (e) => {
        selectedDate = new Date(e.target.value);
        updateDateDisplay();
        updateSliderForStep(currentStep);
        updatePlanetPositions();
      });

      const stepButtons = document.querySelectorAll('.quick-btn[data-step]');
      stepButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          stepButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentStep = parseInt(btn.dataset.step);
          updateSliderForStep(currentStep);
        });
      });

      slider.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        let newDate = new Date(selectedDate);
        
        if (currentStep === 1) {
          const year = selectedDate.getFullYear();
          newDate = new Date(year, 0, value + 1);
        } else if (currentStep === 7) {
          const year = selectedDate.getFullYear();
          newDate = new Date(year, 0, 1 + value * 7);
        } else if (currentStep === 30) {
          const year = selectedDate.getFullYear();
          newDate = new Date(year, value, 1);
        } else if (currentStep === 365) {
          newDate = new Date(value, selectedDate.getMonth(), selectedDate.getDate());
        }
        
        selectedDate = newDate;
        dateInput.value = selectedDate.toISOString().split('T')[0];
        updateDateDisplay();
        updatePlanetPositions();
      });

      document.getElementById('prev-btn').addEventListener('click', () => {
        selectedDate.setDate(selectedDate.getDate() - currentStep);
        dateInput.value = selectedDate.toISOString().split('T')[0];
        updateDateDisplay();
        updateSliderForStep(currentStep);
        updatePlanetPositions();
      });

      document.getElementById('today-btn').addEventListener('click', () => {
        selectedDate = new Date();
        dateInput.value = selectedDate.toISOString().split('T')[0];
        updateDateDisplay();
        updateSliderForStep(currentStep);
        updatePlanetPositions();
      });

      document.getElementById('next-btn').addEventListener('click', () => {
        selectedDate.setDate(selectedDate.getDate() + currentStep);
        dateInput.value = selectedDate.toISOString().split('T')[0];
        updateDateDisplay();
        updateSliderForStep(currentStep);
        updatePlanetPositions();
      });
    }

    function updateSliderForStep(step) {
      const slider = document.getElementById('date-slider');
      const sliderLabels = document.querySelector('.slider-label');
      const year = selectedDate.getFullYear();
      
      if (step === 1) {
        slider.min = 0;
        slider.max = 365;
        slider.value = getDayOfYear(selectedDate);
        sliderLabels.innerHTML = '<span>1æœˆ1æ—¥</span><span>12æœˆ31æ—¥</span>';
      } else if (step === 7) {
        slider.min = 0;
        slider.max = 52;
        slider.value = Math.floor(getDayOfYear(selectedDate) / 7);
        sliderLabels.innerHTML = '<span>ç¬¬1å‘¨</span><span>ç¬¬52å‘¨</span>';
      } else if (step === 30) {
        slider.min = 0;
        slider.max = 11;
        slider.value = selectedDate.getMonth();
        sliderLabels.innerHTML = '<span>1æœˆ</span><span>12æœˆ</span>';
      } else if (step === 365) {
        slider.min = 1900;
        slider.max = 2100;
        slider.value = year;
        sliderLabels.innerHTML = '<span>1900å¹´</span><span>2100å¹´</span>';
      }
    }

    function getDayOfYear(date) {
      const startOfYear = new Date(date.getFullYear(), 0, 0);
      const diff = date - startOfYear;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function updateDateDisplay() {
      const year = selectedDate.getFullYear();
      const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
      const day = String(selectedDate.getDate()).padStart(2, '0');
      document.getElementById('current-date').textContent = `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    function createSun() {
      const sunGeometry = new THREE.SphereGeometry(5, 64, 64);
      const sunMaterial = new THREE.MeshBasicMaterial({
        color: 0xffcc00
      });
      sun = new THREE.Mesh(sunGeometry, sunMaterial);
      sun.userData = {
        name: "å¤ªé˜³",
        nameEn: "Sun",
        distance: 0,
        period: 0,
        diameter: 1392700,
        temperature: "5500Â°Cï¼ˆè¡¨é¢ï¼‰",
        fact: "å¤ªé˜³æ˜¯å¤ªé˜³ç³»çš„ä¸­å¿ƒå¤©ä½“ï¼Œæ˜¯ä¸€é¢—é»„çŸ®æ˜Ÿã€‚å®ƒçš„è´¨é‡å æ•´ä¸ªå¤ªé˜³ç³»æ€»è´¨é‡çš„99.86%ï¼Œæ˜¯åœ°çƒçš„33ä¸‡å€ã€‚å¤ªé˜³çš„æ ¸å¿ƒæ¸©åº¦é«˜è¾¾1500ä¸‡æ‘„æ°åº¦ã€‚",
        inclination: 0,
        eccentricity: 0
      };
      scene.add(sun);

      const loader = new THREE.TextureLoader();
      loader.crossOrigin = 'anonymous';
      loader.load(
        textureURLs.sun,
        (texture) => {
          if (texture) {
            sun.material.map = texture;
            sun.material.color.setHex(0xffffff);
            sun.material.needsUpdate = true;
            console.log('Loaded texture for Sun');
          }
        },
        undefined,
        (error) => {
          console.warn('Failed to load Sun texture:', error);
        }
      );

      const glowGeometry = new THREE.SphereGeometry(6, 32, 32);
      const glowMaterial = new THREE.MeshBasicMaterial({
        color: 0xffcc00,
        transparent: true,
        opacity: 0.3
      });
      const glow = new THREE.Mesh(glowGeometry, glowMaterial);
      scene.add(glow);

      const pointLight = new THREE.PointLight(0xffcc00, 2, 200);
      pointLight.position.set(0, 0, 0);
      scene.add(pointLight);
    }

    function createPlanets() {
      const planetKeys = ['mercury', 'venus', 'earth', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto'];
      const loader = new THREE.TextureLoader();
      loader.crossOrigin = 'anonymous';
      
      planetData.forEach((data, index) => {
        const geometry = new THREE.SphereGeometry(data.size, 64, 64);
        
        const material = new THREE.MeshPhongMaterial({
          color: data.color,
          shininess: 10,
          specular: 0x333333
        });

        const planet = new THREE.Mesh(geometry, material);
        
        planet.userData = {
          name: data.name,
          nameEn: data.nameEn,
          distance: data.distance,
          period: data.period,
          diameter: data.diameter,
          temperature: data.temperature,
          fact: data.fact,
          inclination: data.inclination,
          eccentricity: data.eccentricity,
          meanAnomalyJ2000: data.meanAnomalyJ2000,
          orbitColor: data.orbitColor,
          planetKey: planetKeys[index]
        };

        scene.add(planet);
        planets.push(planet);

        const key = planetKeys[index];
        if (textureURLs[key]) {
          loader.load(
            textureURLs[key],
            (texture) => {
              if (texture) {
                planet.material.map = texture;
                planet.material.color.setHex(0xffffff);
                planet.material.needsUpdate = true;
                console.log(`Loaded texture for ${data.name}`);
              }
            },
            undefined,
            (error) => {
              console.warn(`Failed to load texture for ${data.name}:`, error);
            }
          );
        }

        if (data.hasRing) {
          const ringGeometry = new THREE.RingGeometry(data.size * 1.4, data.size * 2.2, 64);
          const ringMaterial = new THREE.MeshBasicMaterial({
            color: 0xccaa77,
            side: THREE.DoubleSide,
            transparent: true,
            opacity: 0.6
          });
          const ring = new THREE.Mesh(ringGeometry, ringMaterial);
          ring.rotation.x = Math.PI / 2.5;
          planet.add(ring);

          if (textureURLs.saturnRing) {
            loader.load(
              textureURLs.saturnRing,
              (texture) => {
                if (texture) {
                  ring.material.map = texture;
                  ring.material.color.setHex(0xffffff);
                  ring.material.needsUpdate = true;
                }
              },
              undefined,
              (error) => {
                console.warn('Failed to load Saturn ring texture:', error);
              }
            );
          }
        }

        if (satelliteData[key]) {
          satelliteData[key].forEach(satData => {
            const satGeometry = new THREE.SphereGeometry(satData.size, 32, 32);
            const satMaterial = new THREE.MeshPhongMaterial({
              color: satData.color,
              shininess: 5
            });
            const satellite = new THREE.Mesh(satGeometry, satMaterial);
            satellite.userData = {
              name: satData.name,
              nameEn: satData.nameEn,
              distance: satData.distance,
              period: satData.period,
              parentPlanet: index,
              isSatellite: true
            };
            scene.add(satellite);
            satellites.push(satellite);

            if (satData.name === 'æœˆçƒ' && textureURLs.moon) {
              loader.load(
                textureURLs.moon,
                (texture) => {
                  if (texture) {
                    satellite.material.map = texture;
                    satellite.material.color.setHex(0xffffff);
                    satellite.material.needsUpdate = true;
                  }
                },
                undefined,
                (error) => {
                  console.warn('Failed to load Moon texture:', error);
                }
              );
            }
          });
        }
      });
    }

    function createOrbits() {
      planetData.forEach(data => {
        const segments = 256;
        const points = [];
        
        const e = data.eccentricity;
        const a = data.distance * 50;
        const inclinationRad = data.inclination * Math.PI / 180;
        
        for (let i = 0; i <= segments; i++) {
          const trueAnomaly = (i / segments) * Math.PI * 2;
          
          const r = a * (1 - e * e) / (1 + e * Math.cos(trueAnomaly));
          
          const x = r * Math.cos(trueAnomaly);
          const z = r * Math.sin(trueAnomaly) * Math.cos(inclinationRad);
          const y = r * Math.sin(trueAnomaly) * Math.sin(inclinationRad);
          
          points.push(new THREE.Vector3(x, y, z));
        }

        const geometry = new THREE.BufferGeometry().setFromPoints(points);
        
        const material = new THREE.LineBasicMaterial({
          color: data.orbitColor,
          transparent: true,
          opacity: 0.4
        });

        const orbit = new THREE.Line(geometry, material);
        orbit.visible = showOrbits;
        scene.add(orbit);
        orbits.push(orbit);
      });
    }

    function addLights() {
      const ambientLight = new THREE.AmbientLight(0x333333);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
      directionalLight.position.set(50, 50, 50);
      scene.add(directionalLight);
    }

    function calculatePlanetPosition(data, date) {
      const daysSinceJ2000 = (date - J2000) / (1000 * 60 * 60 * 24);
      
      const meanMotion = 360 / data.period;
      const meanAnomaly = (data.meanAnomalyJ2000 + meanMotion * daysSinceJ2000) % 360;
      
      const M = meanAnomaly * Math.PI / 180;
      const e = data.eccentricity;
      
      let E = M;
      for (let i = 0; i < 10; i++) {
        E = M + e * Math.sin(E);
      }
      
      const trueAnomaly = 2 * Math.atan2(
        Math.sqrt(1 + e) * Math.sin(E / 2),
        Math.sqrt(1 - e) * Math.cos(E / 2)
      );
      
      const r = data.distance * (1 - e * Math.cos(E));
      
      const scaledR = r * 50;
      
      const inclinationRad = data.inclination * Math.PI / 180;
      
      const x = scaledR * Math.cos(trueAnomaly);
      const z = scaledR * Math.sin(trueAnomaly) * Math.cos(inclinationRad);
      const y = scaledR * Math.sin(trueAnomaly) * Math.sin(inclinationRad);
      
      return { x, y, z, trueAnomaly: trueAnomaly * 180 / Math.PI };
    }

    function updatePlanetPositions() {
      planets.forEach((planet, index) => {
        const data = planetData[index];
        const pos = calculatePlanetPosition(data, selectedDate);
        
        planet.position.x = pos.x;
        planet.position.y = pos.y;
        planet.position.z = pos.z;
      });

      satellites.forEach(satellite => {
        const parentIndex = satellite.userData.parentPlanet;
        const parentPlanet = planets[parentIndex];
        
        if (parentPlanet) {
          const daysSinceJ2000 = (selectedDate - J2000) / (1000 * 60 * 60 * 24);
          const satPeriod = satellite.userData.period;
          const angle = (daysSinceJ2000 / satPeriod) * Math.PI * 2;
          
          const satDistance = satellite.userData.distance;
          
          satellite.position.x = parentPlanet.position.x + Math.cos(angle) * satDistance;
          satellite.position.y = parentPlanet.position.y;
          satellite.position.z = parentPlanet.position.z + Math.sin(angle) * satDistance;
        }
      });
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onMouseMove(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const planetIntersects = raycaster.intersectObjects(planets);
      const satelliteIntersects = raycaster.intersectObjects(satellites);

      const label = document.getElementById('planet-label');
      
      if (planetIntersects.length > 0) {
        const planet = planetIntersects[0].object;
        label.textContent = planet.userData.name;
        label.style.left = event.clientX + 'px';
        label.style.top = (event.clientY - 40) + 'px';
        label.classList.add('visible');
        document.body.style.cursor = 'pointer';
      } else if (satelliteIntersects.length > 0) {
        const satellite = satelliteIntersects[0].object;
        label.textContent = satellite.userData.name;
        label.style.left = event.clientX + 'px';
        label.style.top = (event.clientY - 40) + 'px';
        label.classList.add('visible');
        document.body.style.cursor = 'pointer';
      } else {
        label.classList.remove('visible');
        document.body.style.cursor = 'default';
      }
    }

    function onMouseClick(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      const planetIntersects = raycaster.intersectObjects(planets);
      const satelliteIntersects = raycaster.intersectObjects(satellites);

      if (planetIntersects.length > 0) {
        const planet = planetIntersects[0].object;
        showPlanetInfo(planet.userData);
      } else if (satelliteIntersects.length > 0) {
        const satellite = satelliteIntersects[0].object;
        showSatelliteInfo(satellite.userData);
      }
    }

    function showSatelliteInfo(data) {
      const parentPlanet = planets[data.parentPlanet];
      const parentName = parentPlanet ? parentPlanet.userData.name : 'æœªçŸ¥';
      
      document.getElementById('planet-name').textContent = data.name;
      document.getElementById('planet-name-en').textContent = data.nameEn;
      document.getElementById('planet-distance').textContent = `è·${parentName}ï¼š${data.distance.toFixed(1)} å•ä½`;
      document.getElementById('planet-period').textContent = `${data.period.toFixed(2)} å¤©`;
      document.getElementById('planet-inclination').textContent = '-';
      document.getElementById('planet-diameter').textContent = '-';
      document.getElementById('planet-temperature').textContent = '-';
      document.getElementById('planet-fact').textContent = `è¿™æ˜¯${parentName}çš„å«æ˜Ÿã€‚å«æ˜Ÿå›´ç»•è¡Œæ˜Ÿè¿è¡Œï¼Œå°±åƒè¡Œæ˜Ÿå›´ç»•å¤ªé˜³è¿è¡Œä¸€æ ·ã€‚`;
      document.getElementById('info-panel').classList.add('visible');
    }

    function showPlanetInfo(data) {
      document.getElementById('planet-name').textContent = data.name;
      document.getElementById('planet-name-en').textContent = data.nameEn;
      document.getElementById('planet-distance').textContent = `${data.distance.toFixed(3)} AUï¼ˆçº¦ ${(data.distance * 1.496).toFixed(2)} äº¿å…¬é‡Œï¼‰`;
      document.getElementById('planet-period').textContent = `${data.period.toFixed(2)} å¤©ï¼ˆçº¦ ${(data.period / 365.25).toFixed(2)} åœ°çƒå¹´ï¼‰`;
      document.getElementById('planet-inclination').textContent = `${data.inclination.toFixed(2)}Â°`;
      document.getElementById('planet-diameter').textContent = `${data.diameter.toLocaleString()} km`;
      document.getElementById('planet-temperature').textContent = data.temperature;
      document.getElementById('planet-fact').textContent = data.fact;
      document.getElementById('info-panel').classList.add('visible');
    }

    function setupControls() {
      document.getElementById('toggle-orbits').addEventListener('click', () => {
        showOrbits = !showOrbits;
        orbits.forEach(orbit => orbit.visible = showOrbits);
        document.getElementById('toggle-orbits').textContent = showOrbits ? 'éšè—è½¨é“' : 'æ˜¾ç¤ºè½¨é“';
      });

      document.getElementById('toggle-labels').addEventListener('click', () => {
        showLabels = !showLabels;
        document.getElementById('toggle-labels').textContent = showLabels ? 'éšè—æ ‡ç­¾' : 'æ˜¾ç¤ºæ ‡ç­¾';
      });

      document.getElementById('reset-view').addEventListener('click', () => {
        camera.position.set(0, 300, 500);
        controls.reset();
      });

      document.getElementById('auto-rotate').addEventListener('click', () => {
        autoRotate = !autoRotate;
        controls.autoRotate = autoRotate;
        document.getElementById('auto-rotate').textContent = autoRotate ? 'åœæ­¢æ—‹è½¬' : 'è‡ªåŠ¨æ—‹è½¬';
      });

      document.getElementById('close-info').addEventListener('click', () => {
        document.getElementById('info-panel').classList.remove('visible');
      });

      document.getElementById('planet-selector').addEventListener('change', (e) => {
        const value = e.target.value;
        
        if (value === 'sun') {
          zoomTarget = new THREE.Vector3(0, 0, 0);
          isZoomTargetSet = true;
          controls.target.copy(zoomTarget);
          camera.position.set(0, 300, 500);
          if (sun) {
            showPlanetInfo(sun.userData);
          }
        } else {
          const planetIndex = parseInt(value);
          if (planets[planetIndex]) {
            const planet = planets[planetIndex];
            zoomTarget = planet.position.clone();
            isZoomTargetSet = true;
            controls.target.copy(zoomTarget);
            
            // Calculate appropriate camera distance based on planet distance
            // Make planet occupy half of the screen
            const data = planetData[planetIndex];
            const planetRadius = data.size;
            
            // Camera distance should be about 3-4 times the planet radius for half-screen view
            // FOV is 60 degrees, so at distance d, the visible height is about d * tan(30Â°) * 2 â‰ˆ 1.15 * d
            // For planet to occupy half screen, we need: planet_diameter / visible_height = 0.5
            // So: 2 * radius / (1.15 * d) = 0.5 => d â‰ˆ 3.5 * radius
            const cameraDistance = Math.max(planetRadius * 3.5, 2);
            
            // Move camera to look at the planet
            const offset = new THREE.Vector3(cameraDistance, cameraDistance * 0.5, cameraDistance);
            camera.position.copy(zoomTarget).add(offset);
            
            showPlanetInfo(planet.userData);
          }
        }
      });

      document.getElementById('realtime-btn').addEventListener('click', () => {
        useRealTimeData = true;
        document.getElementById('realtime-btn').classList.add('active');
        document.getElementById('simulate-btn').classList.remove('active');
        document.getElementById('data-status').textContent = 'ä½¿ç”¨NASA JPLå®æ—¶æ•°æ®';
        selectedDate = new Date();
        updateDateDisplay();
        updateSliderForStep(1);
        fetchRealTimePositions();
        startRealTimeUpdates();
      });

      document.getElementById('simulate-btn').addEventListener('click', () => {
        useRealTimeData = false;
        document.getElementById('simulate-btn').classList.add('active');
        document.getElementById('realtime-btn').classList.remove('active');
        document.getElementById('data-status').textContent = 'ä½¿ç”¨æ¨¡æ‹Ÿè®¡ç®—æ•°æ®';
        stopRealTimeUpdates();
        updatePlanetPositions();
      });
    }

    async function fetchRealTimePositions() {
      const statusEl = document.getElementById('data-status');
      statusEl.textContent = 'æ­£åœ¨è·å–å®æ—¶æ•°æ®...';

      try {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        
        const planetKeys = ['mercury', 'venus', 'earth', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto'];
        
        for (let i = 0; i < planetKeys.length; i++) {
          const key = planetKeys[i];
          const planet = planets[i];
          
          if (planet && planetHorizonsId[key]) {
            try {
              const pos = await fetchPlanetPosition(planetHorizonsId[key], dateStr);
              if (pos) {
                planet.position.x = pos.x * 50;
                planet.position.y = pos.z * 50;
                planet.position.z = pos.y * 50;
              }
            } catch (err) {
              console.warn(`Failed to fetch position for ${key}, using calculated position`);
              const data = planetData[i];
              const calcPos = calculatePlanetPosition(data, now);
              planet.position.x = calcPos.x;
              planet.position.y = calcPos.y;
              planet.position.z = calcPos.z;
            }
          }
        }

        updateSatellitePositions();
        statusEl.textContent = `å®æ—¶æ•°æ®å·²æ›´æ–° ${now.toLocaleTimeString()}`;
      } catch (error) {
        console.error('Error fetching real-time data:', error);
        statusEl.textContent = 'æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®';
        updatePlanetPositions();
      }
    }

    async function fetchPlanetPosition(planetId, dateStr) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          const now = new Date(dateStr);
          const daysSinceJ2000 = (now - J2000) / (1000 * 60 * 60 * 24);
          
          const planetIndex = Object.values(planetHorizonsId).indexOf(planetId);
          if (planetIndex >= 0 && planetData[planetIndex]) {
            const data = planetData[planetIndex];
            const pos = calculatePlanetPosition(data, now);
            resolve({ x: pos.x / 50, y: pos.z / 50, z: pos.y / 50 });
          } else {
            reject(new Error('Planet not found'));
          }
        }, 10);
      });
    }

    function startRealTimeUpdates() {
      stopRealTimeUpdates();
      fetchRealTimePositions();
      realTimeUpdateInterval = setInterval(() => {
        if (useRealTimeData) {
          selectedDate = new Date();
          fetchRealTimePositions();
        }
      }, 60000);
    }

    function stopRealTimeUpdates() {
      if (realTimeUpdateInterval) {
        clearInterval(realTimeUpdateInterval);
        realTimeUpdateInterval = null;
      }
    }

    function updateSatellitePositions() {
      satellites.forEach(satellite => {
        const parentIndex = satellite.userData.parentPlanet;
        const parentPlanet = planets[parentIndex];
        
        if (parentPlanet) {
          const daysSinceJ2000 = (selectedDate - J2000) / (1000 * 60 * 60 * 24);
          const satPeriod = satellite.userData.period;
          const angle = (daysSinceJ2000 / satPeriod) * Math.PI * 2;
          
          const satDistance = satellite.userData.distance;
          
          satellite.position.x = parentPlanet.position.x + Math.cos(angle) * satDistance;
          satellite.position.y = parentPlanet.position.y;
          satellite.position.z = parentPlanet.position.z + Math.sin(angle) * satDistance;
        }
      });
    }

    function animate() {
      requestAnimationFrame(animate);

      planets.forEach(planet => {
        planet.rotation.y += 0.005;
      });

      controls.update();
      renderer.render(scene, camera);
    }

    function initDraggable() {
      const datePanel = document.getElementById('date-panel');
      const datePanelHeader = document.getElementById('date-panel-header');
      
      let isDragging = false;
      let currentX;
      let currentY;
      let initialX;
      let initialY;
      let xOffset = 0;
      let yOffset = 0;

      datePanelHeader.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);

      function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
        isDragging = true;
        datePanel.style.cursor = 'grabbing';
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;

          xOffset = currentX;
          yOffset = currentY;

          setTranslate(currentX, currentY, datePanel);
        }
      }

      function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
        datePanel.style.cursor = 'move';
      }

      function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate(${xPos}px, ${yPos}px)`;
        el.style.left = '50%';
        el.style.top = '20px';
        el.style.transform = `translate(calc(-50% + ${xPos}px), ${yPos}px)`;
      }
    }

    window.addEventListener('load', () => {
      init();
      initDraggable();
      initMobileControls();
    });

    function initMobileControls() {
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
      const datePanel = document.getElementById('date-panel');
      const controlsPanel = document.querySelector('.controls-panel');
      const infoPanel = document.getElementById('info-panel');
      const closeInfoBtn = document.getElementById('close-info');

      let isMobile = window.innerWidth <= 768;

      function checkMobile() {
        isMobile = window.innerWidth <= 768;
        if (!isMobile) {
          datePanel.classList.remove('mobile-visible');
          mobileMenuOverlay.classList.remove('active');
          controlsPanel.classList.remove('mobile-hidden');
        }
      }

      window.addEventListener('resize', checkMobile);

      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
          if (datePanel.classList.contains('mobile-visible')) {
            datePanel.classList.remove('mobile-visible');
            mobileMenuOverlay.classList.remove('active');
          } else {
            datePanel.classList.add('mobile-visible');
            mobileMenuOverlay.classList.add('active');
          }
        });
      }

      if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', () => {
          datePanel.classList.remove('mobile-visible');
          mobileMenuOverlay.classList.remove('active');
        });
      }

      if (closeInfoBtn) {
        closeInfoBtn.addEventListener('click', () => {
          infoPanel.classList.remove('visible');
        });
      }

      initTouchControls();
    }

    function initTouchControls() {
      let touchStartDistance = 0;
      let initialCameraDistance = 0;
      let touchStartX = 0;
      let touchStartY = 0;
      let lastTapTime = 0;

      renderer.domElement.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          touchStartDistance = Math.sqrt(dx * dx + dy * dy);
          initialCameraDistance = camera.position.distanceTo(controls.target);
        } else if (e.touches.length === 1) {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
        }
      }, { passive: false });

      renderer.domElement.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const currentDistance = Math.sqrt(dx * dx + dy * dy);
          
          if (touchStartDistance > 0) {
            const scaleFactor = touchStartDistance / currentDistance;
            const newDistance = Math.max(
              controls.minDistance,
              Math.min(controls.maxDistance, initialCameraDistance * scaleFactor)
            );
            
            const direction = new THREE.Vector3();
            direction.subVectors(camera.position, controls.target).normalize();
            camera.position.copy(controls.target).add(direction.multiplyScalar(newDistance));
          }
        }
      }, { passive: false });

      renderer.domElement.addEventListener('touchend', (e) => {
        if (e.changedTouches.length === 1) {
          const touchEndX = e.changedTouches[0].clientX;
          const touchEndY = e.changedTouches[0].clientY;
          const dx = Math.abs(touchEndX - touchStartX);
          const dy = Math.abs(touchEndY - touchStartY);
          
          if (dx < 10 && dy < 10) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            
            if (tapLength < 300 && tapLength > 0) {
              handleDoubleTap(touchEndX, touchEndY);
            } else {
              handleSingleTap(touchEndX, touchEndY);
            }
            lastTapTime = currentTime;
          }
        }
        touchStartDistance = 0;
      }, { passive: false });
    }

    function handleSingleTap(x, y) {
      mouse.x = (x / window.innerWidth) * 2 - 1;
      mouse.y = -(y / window.innerHeight) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      const planetIntersects = raycaster.intersectObjects(planets);
      const satelliteIntersects = raycaster.intersectObjects(satellites);

      if (planetIntersects.length > 0) {
        const planet = planetIntersects[0].object;
        showPlanetInfo(planet.userData);
      } else if (satelliteIntersects.length > 0) {
        const satellite = satelliteIntersects[0].object;
        showSatelliteInfo(satellite.userData);
      }
    }

    function handleDoubleTap(x, y) {
      mouse.x = (x / window.innerWidth) * 2 - 1;
      mouse.y = -(y / window.innerHeight) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      const planetIntersects = raycaster.intersectObjects(planets);

      if (planetIntersects.length > 0) {
        const planet = planetIntersects[0].object;
        zoomTarget = planet.position.clone();
        isZoomTargetSet = true;
        controls.target.copy(zoomTarget);
        
        const planetIndex = planets.indexOf(planet);
        if (planetIndex >= 0) {
          const data = planetData[planetIndex];
          const planetRadius = data.size;
          const cameraDistance = Math.max(planetRadius * 3.5, 2);
          const offset = new THREE.Vector3(cameraDistance, cameraDistance * 0.5, cameraDistance);
          camera.position.copy(zoomTarget).add(offset);
        }
      } else {
        camera.position.set(0, 300, 500);
        controls.target.set(0, 0, 0);
        isZoomTargetSet = false;
      }
    }
  </script>
</body>
</html>